#include <stdlib.h> 
#include <stdio.h> 
#include <string.h> 
#include <unistd.h> 
#include <arpa/inet.h>
#include <sys/socket.h>


int main() 
{ 
	pid_t pid; //进程ID
	int sockfd,client_fd;	   		//sock_fd-监听套接字描述符；client_fd-连接套接字描述符
	struct sockaddr_in my_addr;		//本机地址
	struct sockaddr_in remote_addr;	//客户端地址
	char databuff[1024];
	char buf[] = "Hello esp32, I'am mr.hu, you are connected my tcp server.!";
	//创建套接字
	if ((sockfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) 
	{ 
		perror("socket"); 
		exit(1); 
	}
	//设置地址端口可重用
	int val=1;
	setsockopt( sockfd, SOL_SOCKET, SO_REUSEADDR, (char*)&val, sizeof(val) );

	//设置本地地址信息
	my_addr.sin_family=AF_INET; 				//协议族
	my_addr.sin_port=htons(8070); 		        //端口
	my_addr.sin_addr.s_addr=inet_addr("192.168.43.131");//IP地址
	bzero(&(my_addr.sin_zero),8); 				//填充0

	//绑定地址到套接字描述符上
	if (bind(sockfd, (struct sockaddr *)&my_addr, sizeof(struct sockaddr))== -1) 
	{ 
		perror("bind"); 
		exit(1); 
	}
	//在地址端口上监听
	if (listen(sockfd, 10) == -1) 
	{ 
		perror("listen"); 
		exit(1); 
	}
	while(1)
	{
		//等待客户端连接，如果有客户端连接，则产生新的连接套接字
		int sin_size = sizeof(struct sockaddr_in);
		if ((client_fd = accept(sockfd, (struct sockaddr *)&remote_addr,&sin_size)) != -1)
		{
			if((pid = fork()) < 0){
				perror("fork failed");
				exit(0);
			}else if(pid == 0){//子进程
				//输出客户端IP地址
				printf("received a connection from %s\n", inet_ntoa(remote_addr.sin_addr)); 
				//向客户端发送欢迎信息
				if (send(client_fd, buf, sizeof(buf), 0) == -1) 
				{
					perror("send"); 
					close(client_fd); 
					exit(2); 
				}
				//接收客户端数据
				if (recv(client_fd, databuff, sizeof(databuff), 0) == -1)
				{
					perror("recv");
					close(client_fd);
					exit(3);
				}
				//处理
				printf("recv databuff :%s\n", databuff);
				//向客户端发送处理结果
				if (send(client_fd, "this is return...", 19, 0) == -1) 
				{
					perror("send"); 
					close(client_fd); 
					exit(2); 
				}
				//关闭连接套接字 
				close(client_fd); 
				exit(0);
			}
		}else
		{
			perror("accept"); 
			exit(1);
		}
	}
	//关闭监听套接字
	close(sockfd); 
	return 0;
}
